<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUMINARK Reflections</title>
    <script defer src="/_vercel/insights/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/deepchat@latest/dist/bundle.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Professional Color Palette (Softened for "Reflections") */
            --color-primary: #4ade80;
            /* Soft Green */
            --color-primary-light: #86efac;
            --color-primary-dark: #166534;
            --color-accent: #2dd4bf;
            /* Teal */
            --color-accent-warm: #fb923c;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;

            /* Neutral Scale */
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-tertiary: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-border: #475569;

            /* Shadows & Effects */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.2);
            --shadow-glow: 0 0 20px rgba(74, 222, 128, 0.2);

            /* Spacing Grid (8px base) */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;

            /* Typography */
            --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            --font-mono: 'Monaco', 'Courier New', monospace;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: var(--font-family);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
            overflow: hidden;
        }

        /* ===== LAYOUT GRID ===== */
        .app-container {
            display: flex;
            height: 100vh;
            width: 100%;
        }

        /* SIDEBAR */
        .sidebar {
            width: 340px;
            background: linear-gradient(180deg, var(--color-bg-secondary) 0%, rgba(30, 41, 59, 0.95) 100%);
            border-right: 1px solid var(--color-border);
            overflow-y: auto;
            padding: var(--space-lg);
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding-bottom: var(--space-md);
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #064e3b;
            font-size: 1.25rem;
        }

        .sidebar-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .sidebar-subtitle {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            font-weight: 600;
        }

        .form-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .form-section-title {
            font-size: 0.875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-primary-light);
            opacity: 0.9;
        }

        .button-group {
            display: flex;
            gap: var(--space-sm);
            flex-wrap: wrap;
        }

        .btn {
            padding: var(--space-xs) var(--space-sm);
            border: 1px solid var(--color-border);
            background: var(--color-bg-tertiary);
            color: var(--color-text-primary);
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 70px;
        }

        .btn:hover {
            background: var(--color-bg-secondary);
            border-color: var(--color-primary);
            color: var(--color-primary-light);
        }

        .btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: #064e3b;
        }

        .form-input {
            background: var(--color-bg-tertiary);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            padding: var(--space-sm);
            border-radius: 6px;
            font-family: var(--font-family);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(74, 222, 128, 0.1);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 70px;
        }

        .slider-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .slider-icon {
            width: 20px;
            height: 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #064e3b;
        }

        .slider-value {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--color-primary-light);
            min-width: 35px;
            text-align: right;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: var(--shadow-lg), 0 0 10px rgba(74, 222, 128, 0.3);
        }

        .intention-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }

        .btn-intention {
            padding: var(--space-sm) var(--space-md);
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(45, 212, 191, 0.1));
            border: 1px solid var(--color-primary);
            color: var(--color-primary-light);
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .btn-intention:hover {
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            color: #064e3b;
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-analyze {
            width: 100%;
            padding: var(--space-md);
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border: none;
            color: #064e3b;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-top: var(--space-lg);
            transition: all 0.3s ease;
            box-shadow: var(--shadow-glow);
        }

        .btn-analyze:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(74, 222, 128, 0.4);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: linear-gradient(135deg, var(--color-bg-primary) 0%, rgba(15, 23, 42, 0.95) 100%);
        }

        /* HEADER */
        .app-header {
            padding: var(--space-lg);
            background: rgba(30, 41, 59, 0.5);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-lg);
        }

        .header-content {
            flex: 1;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: var(--space-xs);
        }

        .header-subtitle {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .stage-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-md) var(--space-lg);
            background: linear-gradient(135deg, rgba(74, 222, 128, 0.1), rgba(45, 212, 191, 0.1));
            border: 1px solid var(--color-primary);
            border-radius: 12px;
        }

        .stage-number {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stage-label {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            font-weight: 600;
        }

        /* CONTENT GRID */
        .content-grid {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: var(--space-lg);
            padding: var(--space-lg);
            overflow: hidden;
        }

        .panel {
            background: rgba(30, 41, 59, 0.7);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .panel-header {
            padding: var(--space-md) var(--space-lg);
            background: rgba(15, 23, 42, 0.5);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .panel-icon {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #064e3b;
            font-size: 1rem;
        }

        .panel-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .panel-content {
            flex: 1;
            padding: var(--space-lg);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        .insight-block {
            padding: var(--space-md);
            background: rgba(74, 222, 128, 0.05);
            border-left: 3px solid var(--color-primary);
            border-radius: 6px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .insight-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--color-primary-light);
            margin-bottom: var(--space-xs);
        }

        .insight-text {
            font-size: 0.9rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-sm) 0;
            border-bottom: 1px solid rgba(74, 222, 128, 0.1);
        }

        .metric-bar {
            flex: 1;
            height: 6px;
            background: var(--color-bg-tertiary);
            border-radius: 3px;
            margin: 0 var(--space-sm);
            overflow: hidden;
        }

        .metric-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
            border-radius: 3px;
        }

        .metric-value {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-primary-light);
            min-width: 40px;
            text-align: right;
        }

        /* TAB INTERFACE */
        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--color-border);
        }

        .tab-button {
            padding: var(--space-md) var(--space-lg);
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            border-bottom: 2px solid transparent;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .tab-button:hover {
            color: var(--color-text-secondary);
        }

        .tab-button.active {
            color: var(--color-primary-light);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            flex: 1;
            overflow-y: auto;
        }

        /* CHECKBOX GROUP */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--color-bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-item:hover {
            background: var(--color-bg-secondary);
        }

        .checkbox-item.selected {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid var(--color-success);
        }

        .check-mark.hidden {
            display: none;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                max-height: 200px;
            }

            .content-grid {
                grid-template-columns: 1fr;
            }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">üåø</div>
                <div>
                    <div class="sidebar-title">REFLECTIONS</div>
                    <div class="sidebar-subtitle">Human-Centric Growth</div>
                </div>
            </div>

            <!-- Time Horizon -->
            <div class="form-section">
                <div class="form-section-title">üåÖ Time Horizon</div>
                <div class="button-group">
                    <button class="btn" onclick="setState('futureOutlook', 'optimistic')" id="future-opt">üå± New
                        Growth</button>
                    <button class="btn" onclick="setState('futureOutlook', 'uncertain')" id="future-unc">üå´Ô∏è The
                        Unknown</button>
                </div>
                <div class="button-group">
                    <button class="btn" onclick="setState('pastReflection', 'growth')" id="past-growth">üçÇ Letting
                        Go</button>
                    <button class="btn" onclick="setState('pastReflection', 'closure')" id="past-closure">ü™®
                        Foundation</button>
                </div>
            </div>

            <!-- Life Areas (Multi-Select) -->
            <div class="form-section">
                <div class="form-section-title">ü™¥ Life Areas (Select Multiple)</div>
                <div class="checkbox-group" id="life-areas-container">
                    <!-- Injected via JS -->
                </div>
            </div>

            <!-- Energy Check-In -->
            <div class="form-section">
                <div class="form-section-title">üîã Energy Check-In</div>
                <textarea class="form-input" id="emotional-state" placeholder="How is your energy flowing today?"
                    onchange="setState('emotionalState', this.value)"></textarea>
            </div>

            <!-- Metrics Sliders -->
            <div class="form-section">
                <div class="form-section-title">üåø Vital Signs</div>

                <div class="slider-group">
                    <div class="slider-label">
                        <div class="slider-name">
                            <div class="slider-icon">L</div>Mental Load
                        </div>
                        <div class="slider-value" id="complexity-val">5</div>
                    </div>
                    <input type="range" min="0" max="10" value="5" id="complexity"
                        onchange="updateSlider('complexity')">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <div class="slider-name">
                            <div class="slider-icon">G</div>Grounding
                        </div>
                        <div class="slider-value" id="stability-val">5</div>
                    </div>
                    <input type="range" min="0" max="10" value="5" id="stability" onchange="updateSlider('stability')">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <div class="slider-name">
                            <div class="slider-icon">P</div>Pressure
                        </div>
                        <div class="slider-value" id="tension-val">5</div>
                    </div>
                    <input type="range" min="0" max="10" value="5" id="tension" onchange="updateSlider('tension')">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <div class="slider-name">
                            <div class="slider-icon">F</div>Fluidity
                        </div>
                        <div class="slider-value" id="adaptability-val">5</div>
                    </div>
                    <input type="range" min="0" max="10" value="5" id="adaptability"
                        onchange="updateSlider('adaptability')">
                </div>

                <div class="slider-group">
                    <div class="slider-label">
                        <div class="slider-name">
                            <div class="slider-icon">C</div>Clarity
                        </div>
                        <div class="slider-value" id="coherence-val">5</div>
                    </div>
                    <input type="range" min="0" max="10" value="5" id="coherence" onchange="updateSlider('coherence')">
                </div>
            </div>

            <!-- Intention Buttons -->
            <div class="form-section">
                <div class="form-section-title">üîÆ Intention</div>
                <div class="intention-buttons">
                    <button class="btn-intention" onclick="setIntention('depth')">üî¨ Deep Reflection</button>
                    <button class="btn-intention" onclick="setIntention('clarity')">üí° Seeking Clarity</button>
                    <button class="btn-intention" onclick="setIntention('action')">‚ö° Planning Action</button>
                </div>
            </div>

            <!-- Analyze Button -->
            <button class="btn-analyze" onclick="runAnalysis()">
                <i class="fas fa-leaf"></i> Reveal Insights
            </button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Header -->
            <div class="app-header">
                <div class="header-content">
                    <div class="header-title">Luminark Reflections</div>
                    <div class="header-subtitle">Your space for growth and pattern recognition</div>
                </div>
                <div class="stage-badge">
                    <div class="stage-number" id="stage-number">‚Äî</div>
                    <div class="stage-label">Current Phase</div>
                </div>
            </div>

            <!-- Content Grid -->
            <div class="content-grid">
                <!-- Left Panel: Deep Reflection -->
                <div class="panel">
                    <div class="panel-header">
                        <div class="panel-icon">üî¨</div>
                        <div class="panel-title">Insight & Reflection</div>
                    </div>
                    <div class="panel-content" id="reflection-content">
                        <p style="color: var(--color-text-muted); text-align: center; padding: var(--space-lg) 0;">
                            Configure your check-in and click <strong>Reveal Insights</strong>...
                        </p>
                    </div>
                </div>

                <!-- Right Panel: Tools -->
                <div class="panel">
                    <div class="tab-container">
                        <button class="tab-button active" id="tab-oracle-btn"
                            onclick="switchTab('oracle')"><span>üîÆ</span> Guidance</button>
                        <button class="tab-button" id="tab-journal-btn" onclick="switchTab('journal')"><span>üìì</span>
                            Journal</button>
                        <button class="tab-button" id="tab-metrics-btn" onclick="switchTab('metrics')"><span>üìà</span>
                            Graph</button>
                        <button class="tab-button" id="tab-chat-btn" onclick="switchTab('chat')"><span>üí¨</span>
                            Agent</button>
                    </div>

                    <!-- Oracle Tab -->
                    <div id="oracle-tab" class="tab-content">
                        <div class="panel-content" id="oracle-content">
                            <p style="color: var(--color-text-muted); text-align: center; padding: var(--space-lg) 0;">
                                Your guidance will appear here...
                            </p>
                        </div>
                    </div>

                    <!-- Journal Tab -->
                    <div id="journal-tab" class="tab-content" style="display: none;">
                        <div class="panel-content">
                            <h3 style="color: var(--color-primary-light); margin-bottom: 1rem;">üìì Deep Journal</h3>
                            <textarea id="deep-journal-input" class="form-input"
                                style="height: 150px; width: 100%; margin-bottom: 1rem;"
                                placeholder="Capture your thoughts..."></textarea>
                            <button class="btn" onclick="saveJournal()">Save Entry</button>
                            <div id="journal-entries" style="margin-top: 2rem;"></div>
                        </div>
                    </div>

                    <!-- Metrics Tab -->
                    <div id="metrics-tab" class="tab-content" style="display: none;">
                        <div class="panel-content">
                            <div id="metrics-display"></div>
                            <!-- Mock Graph -->
                            <div
                                style="margin-top: 2rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem;">WEEKLY RHYTHM</div>
                                <div
                                    style="display: flex; align-items: flex-end; height: 100px; gap: 10px; padding-bottom: 5px; border-bottom: 1px solid #444;">
                                    <div style="width: 20px; height: 30%; background: #4ade80; opacity: 0.5;"></div>
                                    <div style="width: 20px; height: 50%; background: #4ade80; opacity: 0.6;"></div>
                                    <div style="width: 20px; height: 40%; background: #4ade80; opacity: 0.7;"></div>
                                    <div style="width: 20px; height: 80%; background: #4ade80; opacity: 0.8;"></div>
                                    <div style="width: 20px; height: 60%; background: #4ade80; opacity: 1;"></div>
                                </div>
                                <div style="font-size: 0.7rem; color: #666; margin-top: 5px;">M T W T F</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Tab -->
                    <div id="chat-tab" class="tab-content" style="display: none;">
                        <deep-chat id="deepchat" request="{'url': '/api/chat', 'method': 'POST'}"
                            style="height: 100%;"></deep-chat>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== STATE & DATA =====
        let currentState = {
            futureOutlook: '',
            pastReflection: '',
            lifeVectors: [],
            emotionalState: '',
            metrics: { complexity: 5, stability: 5, tension: 5, adaptability: 5, coherence: 5 },
            intention: '',
            currentStage: null,
            journalEntries: []
        };

        const LIFE_AREAS = [
            { id: 'rel', label: 'üíë Relationship' },
            { id: 'car', label: 'üíº Career' },
            { id: 'fin', label: 'üí∞ Finances' },
            { id: 'hea', label: '‚ù§Ô∏è Health' },
            { id: 'spi', label: 'üôè Spirituality' },
            { id: 'pur', label: 'üéØ Purpose' },
            { id: 'adv', label: 'üöÄ Freedom' },
            { id: 'com', label: 'üë• Community' },
            { id: 'cre', label: 'üé® Creativity' }
        ];

        const WISDOM_BASE = {
            "stages": {
                "0": { name: "The Void", pattern: "Stillness. Zero tension. Waiting.", guidance: "Do nothing. Allow the silence." },
                "1": { name: "Emergence", pattern: "First spark. Raw impulse.", guidance: "Follow the energy without judgment." },
                "2": { name: "Duality", pattern: "Tension between two poles.", guidance: "See both sides, then choose." },
                "3": { name: "Expression", pattern: "Outburst of creative force.", guidance: "Create fearlessly." },
                "4": { name: "Foundation", pattern: "Stability and structure.", guidance: "Build systems that last." },
                "5": { name: "Threshold", pattern: "Pressure to change.", guidance: "Prepare to cross over." },
                "6": { name: "Flow", pattern: "Harmony and integration.", guidance: "Ride the wave." },
                "7": { name: "Analysis", pattern: "Deep understanding.", guidance: "Map the patterns." },
                "8": { name: "Mastery", pattern: "Complete knowing.", guidance: "Stay humble in your truth." },
                "9": { name: "Release", pattern: "Completion and letting go.", guidance: "Share your wisdom and dissolve." }
            }
        };

        // ===== FUNCTIONS =====
        function renderLifeAreas() {
            const container = document.getElementById('life-areas-container');
            container.innerHTML = LIFE_AREAS.map(area => `
                <div class="checkbox-item" onclick="toggleLifeArea('${area.id}', this)">
                    <div style="width: 16px; height: 16px; border: 1px solid var(--color-border); border-radius: 4px; display: flex; align-items: center; justify-content: center;">
                        <div class="check-mark hidden" style="width: 8px; height: 8px; background: var(--color-success); border-radius: 2px;"></div>
                    </div>
                    <span>${area.label}</span>
                </div>
            `).join('');
        }

        function toggleLifeArea(id, element) {
            const index = currentState.lifeVectors.indexOf(id);
            const checkMark = element.querySelector('.check-mark');
            if (index === -1) {
                currentState.lifeVectors.push(id);
                element.classList.add('selected');
                checkMark.classList.remove('hidden');
            } else {
                currentState.lifeVectors.splice(index, 1);
                element.classList.remove('selected');
                checkMark.classList.add('hidden');
            }
        }

        function setState(key, value) {
            currentState[key] = value;
            updateButtonStates();
        }

        function updateButtonStates() {
            document.getElementById('future-opt').classList.toggle('active', currentState.futureOutlook === 'optimistic');
            document.getElementById('future-unc').classList.toggle('active', currentState.futureOutlook === 'uncertain');
            document.getElementById('past-growth').classList.toggle('active', currentState.pastReflection === 'growth');
            document.getElementById('past-closure').classList.toggle('active', currentState.pastReflection === 'closure');
        }

        function updateSlider(name) {
            const value = document.getElementById(name).value;
            currentState.metrics[name] = parseInt(value);
            document.getElementById(name + '-val').textContent = value;
        }

        function setIntention(intention) {
            currentState.intention = intention;
        }

        function switchTab(tabName) {
            ['oracle', 'journal', 'metrics', 'chat'].forEach(t => {
                document.getElementById(t + '-tab').style.display = 'none';
                document.getElementById('tab-' + t + '-btn').classList.remove('active');
            });
            document.getElementById(tabName + '-tab').style.display = 'block';
            document.getElementById('tab-' + tabName + '-btn').classList.add('active');
        }

        function saveJournal() {
            const text = document.getElementById('deep-journal-input').value;
            if (!text) return;
            const entry = { date: new Date().toLocaleDateString(), text: text, stage: currentState.currentStage || '-' };
            currentState.journalEntries.unshift(entry);
            document.getElementById('deep-journal-input').value = '';
            renderJournal();
        }

        function renderJournal() {
            document.getElementById('journal-entries').innerHTML = currentState.journalEntries.map(e => `
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 10px; border-left: 3px solid var(--color-primary);">
                    <div style="font-size: 0.75rem; color: var(--color-text-muted); margin-bottom: 4px;">${e.date} ‚Ä¢ Stage ${e.stage}</div>
                    <div>${e.text}</div>
                </div>
            `).join('');
        }

        function calculateStage() {
            const avg = (currentState.metrics.complexity + currentState.metrics.stability +
                currentState.metrics.tension + currentState.metrics.adaptability +
                currentState.metrics.coherence) / 5;
            return Math.floor(avg);
        }

        function runAnalysis() {
            const stage = calculateStage();
            currentState.currentStage = stage;
            const data = WISDOM_BASE.stages[Math.min(stage, 9)] || WISDOM_BASE.stages[0];

            document.getElementById('stage-number').textContent = stage;

            document.getElementById('reflection-content').innerHTML = `
                <div class="insight-block">
                    <div class="insight-title">üìç Stage: ${data.name}</div>
                    <div class="insight-text">${data.pattern}</div>
                </div>
                <div class="insight-block">
                    <div class="insight-title">üó∫Ô∏è Navigation</div>
                    <div class="insight-text">${data.guidance}</div>
                </div>
            `;

            document.getElementById('oracle-content').innerHTML = `
                 <div class="insight-block">
                    <div class="insight-title">üîÆ Oracle Guidance</div>
                    <div class="insight-text">
                        "Your energy in <strong>${data.name}</strong> suggests a need to focus on 
                        ${currentState.lifeVectors.length > 0 ? currentState.lifeVectors.map(id => LIFE_AREAS.find(a => a.id === id).label).join(', ') : 'your center'}.
                        ${currentState.intention ? `Channel your intention of '${currentState.intention}' into this.` : ''}"
                    </div>
                </div>
            `;

            // Metrics Bar HTML
            let metricsHTML = '';
            Object.keys(currentState.metrics).forEach(k => {
                metricsHTML += `
                    <div class="metric-row">
                        <div class="metric-label" style="text-transform:capitalize">${k}</div>
                        <div class="metric-bar"><div class="metric-fill" style="width: ${currentState.metrics[k] * 10}%"></div></div>
                        <div class="metric-value">${currentState.metrics[k]}</div>
                    </div>`;
            });
            document.getElementById('metrics-display').innerHTML = metricsHTML;
            switchTab('oracle');
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateButtonStates();
            renderLifeAreas();
        });
    </script>
</body>

</html>